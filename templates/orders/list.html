{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑—ã —Ü–≤–µ—Ç–æ–≤{% endblock %}
{% block page_title %}üíê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ —Ü–≤–µ—Ç–æ–≤{% endblock %}

{% block content %}
<style>
    .order-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .order-card.status-new {
        border-left-color: #ffc107;
        background-color: #fff9e6;
    }
    .order-card.status-confirmed {
        border-left-color: #28a745;
        background-color: #f0f9f4;
    }
    .order-card.status-in_delivery {
        border-left-color: #007bff;
        background-color: #e7f3ff;
    }
    .order-card.status-completed {
        border-left-color: #17a2b8;
        background-color: #e8f8fa;
    }
    .order-card.status-cancelled {
        border-left-color: #dc3545;
        background-color: #fef0f0;
    }
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .stats-card {
        border-radius: 10px;
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: scale(1.05);
    }
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    .delivery-badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }
    .item-list {
        max-height: 120px;
        overflow-y: auto;
        font-size: 0.9rem;
    }
    .status-flow {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 1rem 0;
        position: relative;
    }
    .status-flow::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: #dee2e6;
        z-index: 0;
    }
    .status-step {
        position: relative;
        z-index: 1;
        background: white;
        padding: 0.5rem;
        text-align: center;
        flex: 1;
    }
    .status-step.active {
        color: #0d6efd;
        font-weight: bold;
    }
    .status-step .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-size: 1.2rem;
    }
    .status-step.active .step-icon {
        background: #0d6efd;
        color: white;
    }
    .status-step.completed .step-icon {
        background: #28a745;
        color: white;
    }
    .kanban-board {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 1rem;
    }
    .kanban-column {
        min-width: 300px;
        flex: 1;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
    }
    .kanban-header {
        font-weight: bold;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }
    .kanban-card {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        border-left: 3px solid;
        cursor: move;
    }
</style>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-3">
    <div class="col-md mb-2">
        <div class="card stats-card text-white bg-warning">
            <div class="card-body text-center py-2">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="bi bi-exclamation-circle fs-4 me-2"></i>
                    <div>
                        <h4 class="mb-0">{{ orders|selectattr('status', 'equalto', 'new')|list|length }}</h4>
                        <small>–ù–æ–≤—ã–µ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md mb-2">
        <div class="card stats-card text-white bg-success">
            <div class="card-body text-center py-2">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="bi bi-check-circle fs-4 me-2"></i>
                    <div>
                        <h4 class="mb-0">{{ orders|selectattr('status', 'equalto', 'confirmed')|list|length }}</h4>
                        <small>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md mb-2">
        <div class="card stats-card text-white bg-primary">
            <div class="card-body text-center py-2">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="bi bi-truck fs-4 me-2"></i>
                    <div>
                        <h4 class="mb-0">{{ orders|selectattr('status', 'equalto', 'in_delivery')|list|length }}</h4>
                        <small>–í –¥–æ—Å—Ç–∞–≤–∫–µ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md mb-2">
        <div class="card stats-card text-white bg-info">
            <div class="card-body text-center py-2">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="bi bi-check-all fs-4 me-2"></i>
                    <div>
                        <h4 class="mb-0">{{ orders|selectattr('status', 'equalto', 'completed')|list|length }}</h4>
                        <small>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md mb-2">
        <div class="card stats-card text-white bg-secondary">
            <div class="card-body text-center py-2">
                <div class="d-flex align-items-center justify-content-center">
                    <i class="bi bi-flower2 fs-4 me-2"></i>
                    <div>
                        <h4 class="mb-0">{{ orders|length }}</h4>
                        <small>–í—Å–µ–≥–æ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ -->
<div class="card filter-section mb-4">
    <div class="row align-items-end">
        <div class="col-md-3">
            <label class="form-label fw-bold">
                <i class="bi bi-funnel"></i> –°—Ç–∞—Ç—É—Å:
            </label>
            <form method="GET" id="filterForm">
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">–í—Å–µ –∑–∞–∫–∞–∑—ã</option>
                    <option value="new" {% if status == 'new' %}selected{% endif %}>üÜï –ù–æ–≤—ã–µ</option>
                    <option value="confirmed" {% if status == 'confirmed' %}selected{% endif %}>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
                    <option value="in_delivery" {% if status == 'in_delivery' %}selected{% endif %}>üöö –í –¥–æ—Å—Ç–∞–≤–∫–µ</option>
                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>‚úîÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                    <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</option>
                </select>
            </form>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">
                <i class="bi bi-geo-alt"></i> –¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:
            </label>
            <select class="form-select" id="deliveryFilter" onchange="filterByDelivery()">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</option>
                <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">
                <i class="bi bi-search"></i> –ü–æ–∏—Å–∫:
            </label>
            <input type="text" class="form-control" id="searchInput" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –∞–¥—Ä–µ—Å..." onkeyup="searchOrders()">
        </div>
        <div class="col-md-2">
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="switchView('cards')" id="cardsViewBtn" title="–ö–∞—Ä—Ç–æ—á–∫–∏">
                    <i class="bi bi-grid-3x3"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="switchView('table')" id="tableViewBtn" title="–¢–∞–±–ª–∏—Ü–∞">
                    <i class="bi bi-list"></i>
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="switchView('kanban')" id="kanbanViewBtn" title="–ö–∞–Ω–±–∞–Ω">
                    <i class="bi bi-kanban"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –í–∏–¥ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
<div id="cardsView">
    {% if orders %}
        <div class="row" id="ordersContainer">
            {% for order in orders %}
            <div class="col-md-6 col-lg-4 mb-3 order-item"
                 data-status="{{ order.status }}"
                 data-delivery="{{ order.delivery_type }}"
                 data-search="{{ order.user_name|lower }} {{ order.phone }} {{ order.delivery_address|lower if order.delivery_address else '' }}">
                <div class="card order-card status-{{ order.status }} h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge bg-dark">#{{ order.id }}</span>
                        {% if order.status == 'new' %}
                            <span class="badge bg-warning text-dark">üÜï –ù–æ–≤—ã–π</span>
                        {% elif order.status == 'confirmed' %}
                            <span class="badge bg-success">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
                        {% elif order.status == 'in_delivery' %}
                            <span class="badge bg-primary">üöö –í –¥–æ—Å—Ç–∞–≤–∫–µ</span>
                        {% elif order.status == 'completed' %}
                            <span class="badge bg-info">‚úîÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                        {% elif order.status == 'cancelled' %}
                            <span class="badge bg-danger">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-person-circle"></i> {{ order.user_name }}
                        </h5>

                        <div class="mb-2">
                            <i class="bi bi-calendar3 text-primary"></i>
                            <small class="text-muted">{{ order.created_at[:16] if order.created_at else 'N/A' }}</small>
                        </div>

                        <div class="mb-2">
                            <i class="bi bi-telephone text-danger"></i>
                            {% if order.phone %}
                                <a href="tel:{{ order.phone }}" class="text-decoration-none">{{ order.phone }}</a>
                            {% else %}
                                <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {% if order.delivery_type == 'pickup' %}
                                <span class="badge delivery-badge bg-secondary">
                                    <i class="bi bi-shop"></i> –°–∞–º–æ–≤—ã–≤–æ–∑
                                </span>
                            {% else %}
                                <span class="badge delivery-badge bg-primary">
                                    <i class="bi bi-truck"></i> –î–æ—Å—Ç–∞–≤–∫–∞
                                </span>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-geo-alt"></i>
                                        {{ order.delivery_address[:50] if order.delivery_address else '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω' }}
                                        {% if order.delivery_address and order.delivery_address|length > 50 %}...{% endif %}
                                    </small>
                                </div>
                                {% if order.delivery_time %}
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> {{ order.delivery_time }}
                                    </small>
                                </div>
                                {% endif %}
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <strong>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</strong>
                            <div class="item-list">
                                {% set items_str = order.get('items', '[]') or '[]' %}
                                {% set items_list = items_str | parse_json %}
                                {% if items_list %}
                                    {% for item in items_list %}
                                        <div class="mb-1">
                                            <small>
                                                ‚Ä¢ {{ item.name }}
                                                {% if item.quantity > 1 %}
                                                    <span class="badge bg-secondary">√ó{{ item.quantity }}</span>
                                                {% endif %}
                                                {% if item.price > 0 %}
                                                    - {{ item.price }} ‚ÇΩ
                                                {% endif %}
                                            </small>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <small class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</small>
                                {% endif %}
                            </div>
                        </div>

                        {% if order.card_text %}
                        <div class="alert alert-light py-2 mb-3">
                            <small>
                                <i class="bi bi-card-text"></i>
                                <strong>–¢–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã—Ç–∫–∏:</strong><br>
                                {{ order.card_text }}
                            </small>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <i class="bi bi-cash-stack text-success"></i>
                            <strong class="fs-5">{{ order.total_amount }} ‚ÇΩ</strong>
                            {% if order.paid %}
                                <span class="badge bg-success ms-2"><i class="bi bi-check-circle"></i> –û–ø–ª–∞—á–µ–Ω–æ</span>
                            {% else %}
                                <span class="badge bg-warning text-dark ms-2"><i class="bi bi-clock"></i> –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã</span>
                            {% endif %}
                        </div>

                        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–∫–∞–∑–∞ -->
                        <div class="status-flow mb-3">
                            <div class="status-step {{ 'completed' if order.status in ['confirmed', 'in_delivery', 'completed'] else ('active' if order.status == 'new' else '') }}">
                                <div class="step-icon"><i class="bi bi-bag-plus"></i></div>
                                <small>–ù–æ–≤—ã–π</small>
                            </div>
                            <div class="status-step {{ 'completed' if order.status in ['in_delivery', 'completed'] else ('active' if order.status == 'confirmed' else '') }}">
                                <div class="step-icon"><i class="bi bi-check"></i></div>
                                <small>–ü–æ–¥—Ç–≤.</small>
                            </div>
                            <div class="status-step {{ 'completed' if order.status == 'completed' else ('active' if order.status == 'in_delivery' else '') }}">
                                <div class="step-icon"><i class="bi bi-truck"></i></div>
                                <small>–î–æ—Å—Ç–∞–≤–∫–∞</small>
                            </div>
                            <div class="status-step {{ 'completed' if order.status == 'completed' else '' }}">
                                <div class="step-icon"><i class="bi bi-check-all"></i></div>
                                <small>–ì–æ—Ç–æ–≤–æ</small>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            {% if order.status == 'new' %}
                                <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                    <input type="hidden" name="status" value="confirmed">
                                    <button type="submit" class="btn btn-success btn-sm w-100">
                                        <i class="bi bi-check-lg"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                    <input type="hidden" name="status" value="cancelled">
                                    <button type="submit" class="btn btn-danger btn-sm w-100">
                                        <i class="bi bi-x-lg"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                                    </button>
                                </form>
                            {% elif order.status == 'confirmed' %}
                                <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                    <input type="hidden" name="status" value="in_delivery">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">
                                        <i class="bi bi-truck"></i> –í –¥–æ—Å—Ç–∞–≤–∫—É
                                    </button>
                                </form>
                            {% elif order.status == 'in_delivery' %}
                                <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                    <input type="hidden" name="status" value="completed">
                                    <button type="submit" class="btn btn-info btn-sm w-100">
                                        <i class="bi bi-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                                    </button>
                                </form>
                            {% endif %}
                            <a href="{{ url_for('user_detail', user_id=order.user_id) }}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-person"></i> –ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle fs-3"></i>
            <p class="mb-0 mt-2">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ {% if status %}–ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É{% endif %}</p>
        </div>
    {% endif %}
</div>

<!-- –¢–∞–±–ª–∏—á–Ω—ã–π –≤–∏–¥ -->
<div id="tableView" style="display: none;">
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                            <th>–°–æ—Å—Ç–∞–≤</th>
                            <th>–î–æ—Å—Ç–∞–≤–∫–∞</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td><strong>#{{ order.id }}</strong></td>
                            <td><small>{{ order.created_at[:16] if order.created_at else 'N/A' }}</small></td>
                            <td>{{ order.user_name }}</td>
                            <td>
                                {% if order.phone %}
                                    <a href="tel:{{ order.phone }}">{{ order.phone }}</a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-truncate d-inline-block" style="max-width: 150px;">
                                    {% set order_items = order.get('items', '-') or '-' %}
                                    {{ order_items[:40] if order_items != '-' else '-' }}
                                    {% if order_items != '-' and order_items|length > 40 %}...{% endif %}
                                </small>
                            </td>
                            <td>
                                {% if order.delivery_type == 'pickup' %}
                                    <span class="badge bg-secondary">–°–∞–º–æ–≤—ã–≤–æ–∑</span>
                                {% else %}
                                    <span class="badge bg-primary">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ order.total_amount }} ‚ÇΩ</strong></td>
                            <td>
                                {% if order.status == 'new' %}
                                    <span class="badge bg-warning text-dark">üÜï –ù–æ–≤—ã–π</span>
                                {% elif order.status == 'confirmed' %}
                                    <span class="badge bg-success">‚úÖ –ü–æ–¥—Ç–≤.</span>
                                {% elif order.status == 'in_delivery' %}
                                    <span class="badge bg-primary">üöö –î–æ—Å—Ç–∞–≤–∫–∞</span>
                                {% elif order.status == 'completed' %}
                                    <span class="badge bg-info">‚úîÔ∏è –ì–æ—Ç–æ–≤–æ</span>
                                {% elif order.status == 'cancelled' %}
                                    <span class="badge bg-danger">‚ùå –û—Ç–º–µ–Ω–∞</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if order.status == 'new' %}
                                        <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                            <input type="hidden" name="status" value="confirmed">
                                            <button type="submit" class="btn btn-success" title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å"><i class="bi bi-check-lg"></i></button>
                                        </form>
                                        <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                            <input type="hidden" name="status" value="cancelled">
                                            <button type="submit" class="btn btn-danger" title="–û—Ç–º–µ–Ω–∏—Ç—å"><i class="bi bi-x-lg"></i></button>
                                        </form>
                                    {% elif order.status == 'confirmed' %}
                                        <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                            <input type="hidden" name="status" value="in_delivery">
                                            <button type="submit" class="btn btn-primary" title="–í –¥–æ—Å—Ç–∞–≤–∫—É"><i class="bi bi-truck"></i></button>
                                        </form>
                                    {% elif order.status == 'in_delivery' %}
                                        <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="d-inline">
                                            <input type="hidden" name="status" value="completed">
                                            <button type="submit" class="btn btn-info" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å"><i class="bi bi-check-circle"></i></button>
                                        </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- –ö–∞–Ω–±–∞–Ω –≤–∏–¥ -->
<div id="kanbanView" style="display: none;">
    <div class="kanban-board">
        <!-- –ù–æ–≤—ã–µ -->
        <div class="kanban-column">
            <div class="kanban-header text-warning">
                <i class="bi bi-exclamation-circle"></i> –ù–æ–≤—ã–µ ({{ orders|selectattr('status', 'equalto', 'new')|list|length }})
            </div>
            {% for order in orders if order.status == 'new' %}
            <div class="kanban-card" style="border-left-color: #ffc107;">
                <strong>#{{ order.id }}</strong> - {{ order.user_name }}<br>
                <small>{{ order.total_amount }} ‚ÇΩ</small><br>
                {% set order_items = order.get('items', '-') or '-' %}
                <small class="text-muted">{{ order_items[:30] if order_items != '-' else '-' }}...</small>
                <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="mt-2">
                    <input type="hidden" name="status" value="confirmed">
                    <button type="submit" class="btn btn-sm btn-success w-100">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </form>
            </div>
            {% endfor %}
        </div>

        <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ -->
        <div class="kanban-column">
            <div class="kanban-header text-success">
                <i class="bi bi-check-circle"></i> –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ ({{ orders|selectattr('status', 'equalto', 'confirmed')|list|length }})
            </div>
            {% for order in orders if order.status == 'confirmed' %}
            <div class="kanban-card" style="border-left-color: #28a745;">
                <strong>#{{ order.id }}</strong> - {{ order.user_name }}<br>
                <small>{{ order.total_amount }} ‚ÇΩ</small><br>
                {% set order_items = order.get('items', '-') or '-' %}
                <small class="text-muted">{{ order_items[:30] if order_items != '-' else '-' }}...</small>
                <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="mt-2">
                    <input type="hidden" name="status" value="in_delivery">
                    <button type="submit" class="btn btn-sm btn-primary w-100">–í –¥–æ—Å—Ç–∞–≤–∫—É</button>
                </form>
            </div>
            {% endfor %}
        </div>

        <!-- –í –¥–æ—Å—Ç–∞–≤–∫–µ -->
        <div class="kanban-column">
            <div class="kanban-header text-primary">
                <i class="bi bi-truck"></i> –í –¥–æ—Å—Ç–∞–≤–∫–µ ({{ orders|selectattr('status', 'equalto', 'in_delivery')|list|length }})
            </div>
            {% for order in orders if order.status == 'in_delivery' %}
            <div class="kanban-card" style="border-left-color: #007bff;">
                <strong>#{{ order.id }}</strong> - {{ order.user_name }}<br>
                <small>{{ order.total_amount }} ‚ÇΩ</small><br>
                <small class="text-muted">
                    {% if order.delivery_address %}
                        <i class="bi bi-geo-alt"></i> {{ order.delivery_address[:25] }}...
                    {% else %}
                        –°–∞–º–æ–≤—ã–≤–æ–∑
                    {% endif %}
                </small>
                <form method="POST" action="{{ url_for('order_update_status', order_id=order.id) }}" class="mt-2">
                    <input type="hidden" name="status" value="completed">
                    <button type="submit" class="btn btn-sm btn-info w-100">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </form>
            </div>
            {% endfor %}
        </div>

        <!-- –í—ã–ø–æ–ª–Ω–µ–Ω–æ -->
        <div class="kanban-column">
            <div class="kanban-header text-info">
                <i class="bi bi-check-all"></i> –í—ã–ø–æ–ª–Ω–µ–Ω–æ ({{ orders|selectattr('status', 'equalto', 'completed')|list|length }})
            </div>
            {% for order in orders if order.status == 'completed' %}
            <div class="kanban-card" style="border-left-color: #17a2b8;">
                <strong>#{{ order.id }}</strong> - {{ order.user_name }}<br>
                <small>{{ order.total_amount }} ‚ÇΩ</small><br>
                <small class="text-muted">{{ order.created_at[:10] if order.created_at else 'N/A' }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
<div class="card mt-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-info-circle"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤:</h6>
                <ul class="small">
                    <li><span class="badge bg-warning text-dark">üÜï –ù–æ–≤—ã–π</span> - –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç, –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</li>
                    <li><span class="badge bg-success">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span> - –∑–∞–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, –≥–æ—Ç–æ–≤–∏—Ç—Å—è</li>
                    <li><span class="badge bg-primary">üöö –í –¥–æ—Å—Ç–∞–≤–∫–µ</span> - –∑–∞–∫–∞–∑ –ø–µ—Ä–µ–¥–∞–Ω –∫—É—Ä—å–µ—Ä—É</li>
                    <li><span class="badge bg-info">‚úîÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span> - –∑–∞–∫–∞–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É</li>
                    <li><span class="badge bg-danger">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</span> - –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</h6>
                <ul class="small">
                    <li>–ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π</li>
                    <li>–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–Ω–±–∞–Ω –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
                    <li>–§–∏–ª—å—Ç—Ä—É–π—Ç–µ –∑–∞–∫–∞–∑—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ —Ç–∏–ø—É –¥–æ—Å—Ç–∞–≤–∫–∏</li>
                    <li>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–∫–∞–∑–∞</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–æ–≤
function switchView(view) {
    document.getElementById('cardsView').style.display = view === 'cards' ? 'block' : 'none';
    document.getElementById('tableView').style.display = view === 'table' ? 'block' : 'none';
    document.getElementById('kanbanView').style.display = view === 'kanban' ? 'block' : 'none';

    document.getElementById('cardsViewBtn').classList.toggle('active', view === 'cards');
    document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
    document.getElementById('kanbanViewBtn').classList.toggle('active', view === 'kanban');
}

// –ü–æ–∏—Å–∫
function searchOrders() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const items = document.querySelectorAll('.order-item');

    items.forEach(item => {
        const searchData = item.dataset.search;
        if (searchData.includes(searchText)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

// –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –¥–æ—Å—Ç–∞–≤–∫–∏
function filterByDelivery() {
    const deliveryFilter = document.getElementById('deliveryFilter').value;
    const items = document.querySelectorAll('.order-item');

    items.forEach(item => {
        if (!deliveryFilter || item.dataset.delivery === deliveryFilter) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}
