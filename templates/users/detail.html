{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ user.user_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üë§ {{ user.user_name }}</h2>
        <a href="{{ url_for('users_list') }}" class="btn btn-secondary">‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th>Telegram ID:</th>
                            <td>{{ user.user_id }}</td>
                        </tr>
                        <tr>
                            <th>–ò–º—è:</th>
                            <td>{{ user.user_name }}</td>
                        </tr>
                        <tr>
                            <th>Username:</th>
                            <td>
                                {% if user.username %}
                                    <a href="https://t.me/{{ user.username }}" target="_blank">@{{ user.username }}</a>
                                {% else %}
                                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω:</th>
                            <td>{{ user.phone or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                        </tr>
                        <tr>
                            <th>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è:</th>
                            <td>
                                {{ user.birthday or '–ù–µ —É–∫–∞–∑–∞–Ω' }}
                                {% if user.birthday %}
                                    <span class="badge bg-info ms-2">üéÇ</span>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                    <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <th>–ë–æ–Ω—É—Å—ã:</th>
                            <td>
                                <span class="badge bg-success fs-6">{{ user.bonus_points }} üíé</span>
                                <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#adjustBonusModal">
                                    <i class="bi bi-pencil"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</th>
                            <td>{{ user.created_at[:16] if user.created_at else '‚Äî' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-primary">{{ stats.appointments_count }}</h3>
                                    <small class="text-muted">–ó–∞–ø–∏—Å–µ–π –≤ —Å–∞–ª–æ–Ω</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-success">{{ stats.orders_count }}</h3>
                                    <small class="text-muted">–ó–∞–∫–∞–∑–æ–≤ —Ü–≤–µ—Ç–æ–≤</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-warning">{{ stats.reviews_count }}</h3>
                                    <small class="text-muted">–û—Ç–∑—ã–≤–æ–≤</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 class="text-danger">{{ stats.total_spent }} ‚ÇΩ</h3>
                                    <small class="text-muted">–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-signpost-2"></i> –ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <th>–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞:</th>
                            <td>
                                {% if user[14] == 'referral' %}
                                    <span class="badge bg-success">–†–µ—Ñ–µ—Ä–∞–ª</span>
                                {% elif user[14] == 'utm' %}
                                    <span class="badge bg-primary">UTM-–∫–∞–º–ø–∞–Ω–∏—è</span>
                                {% else %}
                                    <span class="badge bg-secondary">–û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if user[9] %}
                        <tr>
                            <th>–ò—Å—Ç–æ—á–Ω–∏–∫:</th>
                            <td><span class="badge bg-info">{{ user[9] }}</span></td>
                        </tr>
                        {% endif %}
                        {% if user[10] %}
                        <tr>
                            <th>–ö–∞–Ω–∞–ª:</th>
                            <td>{{ user[10] }}</td>
                        </tr>
                        {% endif %}
                        {% if user[11] %}
                        <tr>
                            <th>–ö–∞–º–ø–∞–Ω–∏—è:</th>
                            <td>{{ user[11] }}</td>
                        </tr>
                        {% endif %}
                        {% if user[6] %}
                        <tr>
                            <th>–ü—Ä–∏–≥–ª–∞—Å–∏–ª:</th>
                            <td>
                                <a href="{{ url_for('user_detail', user_id=user[6]) }}">
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #{{ user[6] }}
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- –ó–∞–ø–∏—Å–∏ –≤ —Å–∞–ª–æ–Ω -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üíÖ –ó–∞–ø–∏—Å–∏ –≤ —Å–∞–ª–æ–Ω ({{ appointments|length }})</h5>
        </div>
        <div class="card-body">
            {% if appointments %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–£—Å–ª—É–≥–∞</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for apt in appointments[:10] %}
                        <tr>
                            <td>{{ apt.id }}</td>
                            <td>{{ apt.service_name }}</td>
                            <td>{{ apt.appointment_date }}</td>
                            <td>{{ apt.time_slot }}</td>
                            <td>
                                {% if apt.status == 'confirmed' %}
                                    <span class="badge bg-success">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</span>
                                {% elif apt.status == 'pending' %}
                                    <span class="badge bg-warning">–û–∂–∏–¥–∞–µ—Ç</span>
                                {% elif apt.status == 'cancelled' %}
                                    <span class="badge bg-danger">–û—Ç–º–µ–Ω–µ–Ω–∞</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ apt.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
            {% endif %}
        </div>
    </div>

    <!-- –ó–∞–∫–∞–∑—ã —Ü–≤–µ—Ç–æ–≤ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üå∏ –ó–∞–∫–∞–∑—ã —Ü–≤–µ—Ç–æ–≤ ({{ orders|length }})</h5>
        </div>
        <div class="card-body">
            {% if orders %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–î–æ—Å—Ç–∞–≤–∫–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders[:10] %}
                        <tr>
                            <td>{{ order.id }}</td>
                            <td>{{ order.total_amount }} ‚ÇΩ</td>
                            <td>{{ order.delivery_type }}</td>
                            <td>
                                {% if order.status == 'completed' %}
                                    <span class="badge bg-success">–í—ã–ø–æ–ª–Ω–µ–Ω</span>
                                {% elif order.status == 'new' %}
                                    <span class="badge bg-info">–ù–æ–≤—ã–π</span>
                                {% elif order.status == 'in_delivery' %}
                                    <span class="badge bg-primary">–í –¥–æ—Å—Ç–∞–≤–∫–µ</span>
                                {% elif order.status == 'cancelled' %}
                                    <span class="badge bg-danger">–û—Ç–º–µ–Ω–µ–Ω</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ order.status }}</span>
                                {% endif %}
                            </td>
                            <td>{{ order.created_at[:10] if order.created_at else '‚Äî' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
            {% endif %}
        </div>
    </div>

    <!-- –û—Ç–∑—ã–≤—ã -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">‚≠ê –û—Ç–∑—ã–≤—ã ({{ reviews|length }})</h5>
        </div>
        <div class="card-body">
            {% if reviews %}
                {% for review in reviews %}
                <div class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>–û—Ü–µ–Ω–∫–∞:</strong>
                            {% for i in range(review.rating) %}‚≠ê{% endfor %}
                            ({{ review.rating }}/5)
                        </div>
                        <small class="text-muted">{{ review.created_at[:10] if review.created_at else '‚Äî' }}</small>
                    </div>
                    <p class="mb-0 mt-2">{{ review.text or '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è' }}</p>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ -->
<div class="modal fade" id="adjustBonusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('user_bonus_adjust', user_id=user.user_id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong>{{ user.bonus_points }} üíé</strong>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤:</label>
                        <input type="number" class="form-control" name="points" required
                               placeholder="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ = –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ = —Å–ø–∏—Å–∞–Ω–∏–µ">
                        <div class="form-text">–ù–∞–ø—Ä–∏–º–µ—Ä: 100 (–Ω–∞—á–∏—Å–ª–∏—Ç—å) –∏–ª–∏ -50 (—Å–ø–∏—Å–∞—Ç—å)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:</label>
                        <input type="text" class="form-control" name="description"
                               value="–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin_edit_user_profile', user_id=user.user_id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è</label>
                        <input type="text" class="form-control" name="first_name"
                               value="{{ user.user_name or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="form-control" name="phone"
                               value="{{ user.phone or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                        <input type="date" class="form-control" name="birthday"
                               value="{{ user.birthday or '' }}">
                        <small class="text-muted">–§–æ—Ä–º–∞—Ç: YYYY-MM-DD</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
